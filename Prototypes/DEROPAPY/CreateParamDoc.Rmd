---
title: "R Notebook"
output: html_notebook
---

```{r}
options(scipen = 999)
library(tidyverse)
library(ggplot2)
```


```{r}
# Read the CSV file into a data frame
data <- read.csv("CropParameters.csv", stringsAsFactors = FALSE)
head(data)
```

```{r}
str(data)
summary(data)
```
# Prepare a working dataframe

```{r}
# Exclude unwanted crops
out_crop <- c("Apple","RyeGrass", "Clover")

# Define the vector with column names to gather (columns to turn into levels)
crop_select <- c("Maize","Wheat",	"Hemp",	"OSR",	"Grapevine",	"Macadamia",	"Lemon",	"Avocado")
crop_type <- data.frame(
  CropName=c("Maize","Wheat",	"Hemp",	"OSR","Grapevine",	"Macadamia",	"Lemon",	"Avocado"),
  CropType=c("Arable","Arable",	"Arable",	"Arable", "Perennial", "Perennial", "Perennial", "Perennial"))

work_data<- data %>%
  dplyr::select(-one_of(out_crop)) %>%
  filter(ParamName!="CropType") %>%
  filter(Category != "PlantNitrogen") %>%
  tidyr::gather(key = "CropName", value = "ParamValue", all_of(crop_select)) %>%
  mutate(ParamNameFull=paste0(ParamName," (",ParamUnit,")")) %>%
  mutate(ParamType = case_when(
    !is.na(suppressWarnings(as.numeric(ParamValue))) ~ "numeric",
    grepl("\\(", ParamValue) ~ "array",                    # Check if value contains "(" (array)
    is.character(ParamValue) ~ "factor",                   # Check if value is a character (factor)
    TRUE ~ NA_character_                          # Default case (optional)
  )) %>% 
  mutate(CropName=fct_relevel(CropName, crop_select)) %>%
  arrange(CropName) %>%
  inner_join(crop_type, by="CropName") 



#str(work_data)
summary(work_data)
#head(work_data)
```


```{r, fig.height== 40}

save_path <- "C:\\github\\ApsimX\\Prototypes\\DEROPAPY\\figures"

select_cat <- "Phenology"
select_cat <- "Structure"
select_cat <- "Carbon"
select_cat <- "Transpiration"
select_cat <- "Canopy"

cats <- unique(work_data$Category)

for(i in 1:length(cats)) {
  
  # filter  
  thisCat_data <- work_data %>%
 # filter(ParamName == select_param) %>%
  #filter(Category == select_cat) %>%
  filter(grepl(cats[i], Category)) %>%
  filter(ParamType == "numeric") %>%
  mutate(ParamValue=as.numeric(as.character(ParamValue))) 
  
  if(nrow(thisCat_data)>0) {
  
  # plot
    
  p <- thisCat_data %>%
  ggplot() +
  geom_bar(stat="identity", aes(x=CropName,y=ParamValue, fill = CropType)) +
  facet_wrap(.~ParamNameFull, scales="free", ncol=2) +
  coord_flip() +
  ylab("Parameter value")+
  xlab("Crop name")+
  labs(title = cats[i] ) 
  
  print(p)
  
  ggsave(filename = paste0(cats[i],".jpg"), dpi=100 )

    
  }
    
  }
  


```


